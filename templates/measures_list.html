{% extends "base.html" %}
{% load static %}

{% block title %}{% if preview_mode %}Measure Previews{% else %}Measures{% endif %}{% endblock %}
{% block content %}

<div class="container xl:max-w-screen-xl pt-2 md:pt-6 pb-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Header Section -->
        <div class="mb-12">
            <h1 class="text-4xl font-bold mb-6 text-gray-900 tracking-tight">
                {% if preview_mode %}Measure Previews{% else %}Measures{% endif %}
            </h1>
            <p class="text-lg text-gray-600 mb-4 leading-relaxed">
                Measures are pre-built analyses of medicines use in hospitals. They provide valuable insights into areas such as cost-effectiveness, patient safety, and adherence to best practices.
            </p>
            <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-8" role="alert">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-amber-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        {% if preview_mode %}
                        <h3 class="text-sm font-medium text-amber-800">Preview Measures Warning</h3>
                        <div class="mt-2 text-sm text-amber-700">
                            <p>These measures are in preview and may not be fully developed or validated. They are provided for early feedback and testing purposes.
                            The text, products selected, and data shown may be incorrect or incomplete. They should not be used for decision making.</p>
                        </div>
                        {% else %}
                        <p class="text-sm text-amber-700">Just because an NHS Trust is an outlier for high or low use, that doesn't necessarily mean they are good or bad. These are measures rather than indicators, and they need to be interpreted judiciously.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Published Measures Section -->
        {% if not preview_mode and measures %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {% for measure in measures %}
            <div class="flex flex-col h-full">
                <div class="relative h-full">
                    <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 flex flex-col h-full border border-gray-100">
                        {% if measure.is_new %}
                        <div class="absolute -top-3 -right-3 z-10">
                            <span class="inline-flex items-center justify-center text-4xl" aria-label="New measure">
                                ðŸ†•
                            </span>
                        </div>
                        {% endif %}
                        <div class="py-2 px-4 border-b border-gray-100 flex items-center rounded-t-xl relative h-[5rem]">
                            <h3 class="text-xl font-semibold text-gray-900 line-clamp-2 leading-tight w-full">
                                {{ measure.short_name }}
                            </h3>
                        </div>
                        <div class="p-4 text-gray-600 flex-grow">
                            <div class="prose prose-sm max-w-none line-clamp-3">
                                {{ measure.description|safe }}
                            </div>
                        </div>
                        <div class="px-6 pb-4">
                            {% if measure.tags.all %}
                            <div class="inline-block">
                                <span class="text-sm font-medium text-gray-500 mr-2">Tags:</span>
                                {% for tag in measure.tags.all %}
                                <span class="inline-flex items-center text-sm font-normal px-3 py-1 rounded-full cursor-help relative group mb-2 mr-2"
                                      style="background-color: {{ tag.colour }}20; color: {{ tag.colour }};">
                                    <span class="w-2 h-2 rounded-full mr-2" style="background-color: {{ tag.colour }}"></span>
                                    {{ tag.name }}
                                    <!-- Tooltip -->
                                    {% if tag.description %}
                                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-4 bg-white rounded-lg shadow-lg 
                                              invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-300
                                              text-sm text-gray-600 z-10">
                                        {{ tag.description|safe }}
                                        <!-- Arrow -->
                                        <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-white transform rotate-45"></div>
                                    </div>
                                    {% endif %}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="p-6 pt-2">
                            <a href="{% url 'viewer:measure_item' measure.slug %}" 
                                class="inline-flex w-full justify-center items-center px-4 py-2 bg-oxford-50 text-oxford-600 rounded-lg hover:bg-oxford-100 transition-colors duration-200 font-medium">
                                View measure
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Preview Measures Section -->
        {% if preview_measures %}
        <div class="mb-12">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {% for measure in preview_measures %}
                <div class="flex flex-col h-full">
                    <div class="relative h-full">
                        <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 flex flex-col h-full border border-gray-100">
                            {% if measure.is_new %}
                            <div class="absolute -top-3 -right-3 z-10">
                                <span class="inline-flex items-center justify-center text-4xl" aria-label="New measure">
                                    ðŸ†•
                                </span>
                            </div>
                            {% endif %}
                            <div class="bg-blue-50 py-2 px-4 border-b border-gray-100 flex items-center rounded-t-xl relative h-[5rem]">
                                <div class="absolute top-0 left-0 right-0 flex items-center justify-center py-1 text-xs font-medium bg-blue-100 text-blue-800">
                                    Preview
                                </div>
                                <h3 class="text-xl font-semibold text-gray-900 line-clamp-2 leading-tight w-full mt-6">
                                    {{ measure.short_name }}
                                </h3>
                            </div>
                            <div class="p-4 text-gray-600 flex-grow">
                                <div class="prose prose-sm max-w-none line-clamp-3">
                                    {{ measure.description|safe }}
                                </div>
                            </div>
                            <div class="px-6 pb-4">
                                {% if measure.tags.all %}
                                <div class="inline-block">
                                    <span class="text-sm font-medium text-gray-500 mr-2">Tags:</span>
                                    {% for tag in measure.tags.all %}
                                    <span class="inline-flex items-center text-sm font-normal px-3 py-1 rounded-full cursor-help relative group mb-2 mr-2"
                                          style="background-color: {{ tag.colour }}20; color: {{ tag.colour }};">
                                        <span class="w-2 h-2 rounded-full mr-2" style="background-color: {{ tag.colour }}"></span>
                                        {{ tag.name }}
                                        <!-- Tooltip -->
                                        {% if tag.description %}
                                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-4 bg-white rounded-lg shadow-lg 
                                                  invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-300
                                                  text-sm text-gray-600 z-10">
                                            {{ tag.description|safe }}
                                            <!-- Arrow -->
                                            <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-white transform rotate-45"></div>
                                        </div>
                                        {% endif %}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="p-6 pt-2">
                                <a href="{% url 'viewer:measure_preview_item' measure.slug %}" 
                                    class="inline-flex w-full justify-center items-center px-4 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors duration-200 font-medium">
                                    View preview
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- In Development Measures Section -->
        {% if in_development_measures %}
        <div class="mb-12">
            <h2 class="text-2xl font-semibold mb-6 text-gray-900">In Development</h2>
            <p class="text-gray-600 mb-6">These measures are currently in development. Public previews are not available for these measures. You can see them because you are logged in.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {% for measure in in_development_measures %}
                <div class="flex flex-col h-full">
                    <div class="relative h-full">
                        <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 flex flex-col h-full border border-gray-100">
                            {% if measure.is_new %}
                            <div class="absolute -top-3 -right-3 z-10">
                                <span class="inline-flex items-center justify-center text-4xl" aria-label="New measure">
                                    ðŸ†•
                                </span>
                            </div>
                            {% endif %}
                            <div class="bg-amber-50 py-2 px-4 border-b border-gray-100 flex items-center rounded-t-xl relative h-[5rem]">
                                <div class="absolute top-0 left-0 right-0 flex items-center justify-center py-1 text-xs font-medium bg-amber-100 text-amber-800">
                                    <span class="mr-1">ðŸš§</span> In development
                                </div>
                                <h3 class="text-xl font-semibold text-gray-900 line-clamp-2 leading-tight w-full mt-6">
                                    {{ measure.short_name }}
                                </h3>
                            </div>
                            <div class="p-4 text-gray-600 flex-grow">
                                <div class="prose prose-sm max-w-none line-clamp-3">
                                    {{ measure.description|safe }}
                                </div>
                            </div>
                            <div class="px-6 pb-4">
                                {% if measure.tags.all %}
                                <div class="inline-block">
                                    <span class="text-sm font-medium text-gray-500 mr-2">Tags:</span>
                                    {% for tag in measure.tags.all %}
                                    <span class="inline-flex items-center text-sm font-normal px-3 py-1 rounded-full cursor-help relative group mb-2 mr-2"
                                          style="background-color: {{ tag.colour }}20; color: {{ tag.colour }};">
                                        <span class="w-2 h-2 rounded-full mr-2" style="background-color: {{ tag.colour }}"></span>
                                        {{ tag.name }}
                                        <!-- Tooltip -->
                                        {% if tag.description %}
                                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-4 bg-white rounded-lg shadow-lg 
                                                  invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-300
                                                  text-sm text-gray-600 z-10">
                                            {{ tag.description|safe }}
                                            <!-- Arrow -->
                                            <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-white transform rotate-45"></div>
                                        </div>
                                        {% endif %}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="p-6 pt-2">
                                <a href="{% url 'viewer:measure_preview_item' measure.slug %}" 
                                    class="inline-flex w-full justify-center items-center px-4 py-2 bg-amber-50 text-amber-600 hover:bg-amber-100 rounded-lg transition-colors duration-200 font-medium">
                                    View in development
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    </div>
</div>

{% endblock %}
